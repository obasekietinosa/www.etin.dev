---
import Layout from "../../layouts/Layout.astro";
import { getNotes, getNote } from "../../domains/Notes";
import Badge from "../../components/Badge.astro";
import Button from "../../components/Button.astro";
import NotePreview from "../../components/NotePreview/NotePreview.astro";
import { marked } from "marked";

export async function getStaticPaths() {
  const notes = await getNotes();
  return notes.map((note) => ({
    params: { slug: note.slug },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

let note;
try {
  note = await getNote(slug);
} catch (error) {
  console.error(`Error fetching note for slug ${slug}:`, error);
  return Astro.redirect('/404');
}

if (!note) {
  return Astro.redirect('/404');
}

const { relatedNotes, relatedItems } = note;
const ogImage = `/og/note/${note.id}.png`;

const renderer = new marked.Renderer();

const escapeHtml = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

renderer.code = function({ text, lang, escaped }) {
  if (lang === 'mermaid') {
    const safeText = escapeHtml(text);
    return `
      <div class="mermaid-wrapper mb-8 group relative my-8 rounded-lg bg-white/5 border border-white/10 ring-1 ring-white/5 overflow-hidden">
        <div class="mermaid-diagram p-4 flex justify-center bg-white/5 overflow-x-auto">
            <div class="mermaid">${safeText}</div>
        </div>
        <div class="mermaid-source hidden bg-zinc-900 overflow-auto p-4">
            <pre class="font-mono text-sm text-zinc-300 h-full w-full whitespace-pre-wrap"><code>${safeText}</code></pre>
        </div>
        <button class="mermaid-toggle absolute top-3 right-3 z-20 p-2 rounded-md bg-zinc-800 text-zinc-400 hover:text-white hover:bg-zinc-700 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" aria-label="View Source">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code-xml"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
        </button>
      </div>
    `;
  }
  return marked.Renderer.prototype.code.call(this, { text, lang, escaped });
};

// Fix API returning escaped backticks
const sanitizedBody = note.body.replace(/\\`/g, '`');
const content = await marked.parse(sanitizedBody, { renderer });
---

<Layout title={note.title} description={note.preview} image={ogImage}>
  <main class="max-w-3xl mx-auto mt-12">
    <Button variant="secondary" size="sm" as="a" href="/notes" class="mb-8 inline-block">
        &larr; Back to writing
    </Button>

    <article class="bg-primary/5 p-8 rounded-lg shadow-bulge border-2 border-primary">
      <h1 class="text-4xl md:text-5xl font-bold mb-6">{note.title}</h1>

      <div class="flex flex-wrap gap-4 mb-8">
        {note.tags.map((tag) => <Badge key={tag.name} {...tag} />)}
      </div>

      <div class="prose prose-lg dark:prose-invert max-w-none" set:html={content} />
    </article>

    {relatedItems && relatedItems.length > 0 && (
      <section class="mt-16">
        <h2 class="text-3xl font-bold mb-8 text-primary">Related Items</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {relatedItems.map((item) => (
            <a href={`/${item.type.toLowerCase()}/${item.slug}`} class="block p-6 rounded-lg bg-zinc-900 border border-zinc-800 hover:border-primary transition-all group no-underline">
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-mono text-primary uppercase tracking-widest">{item.type}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-500 group-hover:text-primary transition-colors transform group-hover:translate-x-1"><path d="M7 7h10v10"/><path d="M7 17 17 7"/></svg>
              </div>
              <h3 class="text-xl font-bold text-white group-hover:text-primary transition-colors">{item.title}</h3>
            </a>
          ))}
        </div>
      </section>
    )}

    {relatedNotes && relatedNotes.length > 0 && (
      <section class="mt-16">
        <h2 class="text-3xl font-bold mb-8 text-primary">Related Notes</h2>
        <ul class="list-none">
          {relatedNotes.map((relatedNote) => (
            <NotePreview note={relatedNote} />
          ))}
        </ul>
      </section>
    )}
  </main>
</Layout>

<script>
  import mermaid from 'mermaid';

  function getTheme() {
    return document.documentElement.classList.contains('light') ? 'default' : 'dark';
  }

  mermaid.initialize({
    startOnLoad: false,
    theme: getTheme(),
    fontFamily: '"Inter", sans-serif',
    securityLevel: 'loose',
  });

  async function initMermaid() {
      await mermaid.run({
          querySelector: '.mermaid',
      });
  }

  function setupMermaidToggles() {
    document.querySelectorAll('.mermaid-toggle').forEach(btn => {
        if (btn.getAttribute('data-listener-attached')) return;
        btn.setAttribute('data-listener-attached', 'true');

        btn.addEventListener('click', (e) => {
            const button = e.currentTarget as HTMLElement;
            const wrapper = button.closest('.mermaid-wrapper');
            if (!wrapper) return;

            const diagram = wrapper.querySelector('.mermaid-diagram');
            const source = wrapper.querySelector('.mermaid-source');

            if (diagram && source) {
                const isHidden = diagram.classList.contains('hidden');

                if (isHidden) {
                    // Show Diagram
                    diagram.classList.remove('hidden');
                    source.classList.add('hidden');
                    button.setAttribute('aria-label', 'View Source');
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code-xml"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>`;
                } else {
                    // Show Source
                    diagram.classList.add('hidden');
                    source.classList.remove('hidden');
                    button.setAttribute('aria-label', 'View Diagram');
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
                }
            }
        });
    });
  }

  // Run on initial load
  initMermaid();
  setupMermaidToggles();

  // Re-run if using View Transitions
  document.addEventListener('astro:page-load', () => {
      initMermaid();
      setupMermaidToggles();
  });
</script>
