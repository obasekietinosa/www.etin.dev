---
import Layout from "../../layouts/Layout.astro";
import { getNotes } from "../../domains/Notes";
import Badge from "../../components/Badge.astro";
import Button from "../../components/Button.astro";
import NotePreview from "../../components/NotePreview/NotePreview.astro";
import { marked } from "marked";

export async function getStaticPaths() {
  const notes = await getNotes();
  return notes.map((note) => {
    const relatedNotes = notes
      .filter((n) => n.id !== note.id)
      .map((n) => ({
        ...n,
        commonTags: n.tags.filter((t) =>
          note.tags.some((nt) => nt.name === t.name)
        ).length,
      }))
      .filter((n) => n.commonTags > 0)
      .sort((a, b) => {
        if (b.commonTags !== a.commonTags) {
          return b.commonTags - a.commonTags;
        }
        return (
          new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime()
        );
      })
      .slice(0, 3)
      .map(({ commonTags, ...n }) => n);

    return {
      params: { slug: note.slug },
      props: { note, relatedNotes },
    };
  });
}

const { note, relatedNotes } = Astro.props;
const ogImage = `/og/note/${note.id}.png`;

const renderer = new marked.Renderer();

const escapeHtml = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

renderer.code = function({ text, lang, escaped }) {
  if (lang === 'mermaid') {
    const safeText = escapeHtml(text);
    return `
      <div class="mermaid-wrapper mb-8 group relative my-8 rounded-lg bg-white/5 border border-white/10 ring-1 ring-white/5 overflow-hidden">
        <div class="mermaid-diagram p-4 flex justify-center bg-white/5 overflow-x-auto">
            <div class="mermaid">${safeText}</div>
        </div>
        <div class="mermaid-source hidden bg-zinc-900 overflow-auto p-4">
            <pre class="font-mono text-sm text-zinc-300 h-full w-full whitespace-pre-wrap"><code>${safeText}</code></pre>
        </div>
        <button class="mermaid-toggle absolute top-3 right-3 z-20 p-2 rounded-md bg-zinc-800 text-zinc-400 hover:text-white hover:bg-zinc-700 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100" aria-label="View Source">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code-xml"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
        </button>
      </div>
    `;
  }
  return marked.Renderer.prototype.code.call(this, { text, lang, escaped });
};

// Fix API returning escaped backticks
const sanitizedBody = note.body.replace(/\\`/g, '`');
const content = await marked.parse(sanitizedBody, { renderer });
---

<Layout title={note.title} description={note.preview} image={ogImage}>
  <main class="max-w-3xl mx-auto mt-12">
    <Button variant="secondary" size="sm" as="a" href="/notes" class="mb-8 inline-block">
        &larr; Back to writing
    </Button>

    <article class="bg-primary/5 p-8 rounded-lg shadow-bulge border-2 border-primary">
      <h1 class="text-4xl md:text-5xl font-bold mb-6">{note.title}</h1>

      <div class="flex flex-wrap gap-4 mb-8">
        {note.tags.map((tag) => <Badge key={tag.name} {...tag} />)}
      </div>

      <div class="prose prose-lg dark:prose-invert max-w-none" set:html={content} />
    </article>

    {relatedNotes && relatedNotes.length > 0 && (
      <section class="mt-16">
        <h2 class="text-3xl font-bold mb-8 text-primary">Related Notes</h2>
        <ul class="list-none">
          {relatedNotes.map((relatedNote) => (
            <NotePreview note={relatedNote} />
          ))}
        </ul>
      </section>
    )}
  </main>
</Layout>

<script>
  import mermaid from 'mermaid';

  function getTheme() {
    return document.documentElement.classList.contains('light') ? 'default' : 'dark';
  }

  mermaid.initialize({
    startOnLoad: false,
    theme: getTheme(),
    fontFamily: '"Inter", sans-serif',
    securityLevel: 'loose',
  });

  async function initMermaid() {
      await mermaid.run({
          querySelector: '.mermaid',
      });
  }

  function setupMermaidToggles() {
    document.querySelectorAll('.mermaid-toggle').forEach(btn => {
        if (btn.getAttribute('data-listener-attached')) return;
        btn.setAttribute('data-listener-attached', 'true');

        btn.addEventListener('click', (e) => {
            const button = e.currentTarget as HTMLElement;
            const wrapper = button.closest('.mermaid-wrapper');
            if (!wrapper) return;

            const diagram = wrapper.querySelector('.mermaid-diagram');
            const source = wrapper.querySelector('.mermaid-source');

            if (diagram && source) {
                const isHidden = diagram.classList.contains('hidden');

                if (isHidden) {
                    // Show Diagram
                    diagram.classList.remove('hidden');
                    source.classList.add('hidden');
                    button.setAttribute('aria-label', 'View Source');
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code-xml"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>`;
                } else {
                    // Show Source
                    diagram.classList.add('hidden');
                    source.classList.remove('hidden');
                    button.setAttribute('aria-label', 'View Diagram');
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
                }
            }
        });
    });
  }

  // Run on initial load
  initMermaid();
  setupMermaidToggles();

  // Re-run if using View Transitions
  document.addEventListener('astro:page-load', () => {
      initMermaid();
      setupMermaidToggles();
  });
</script>
